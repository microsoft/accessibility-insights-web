# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

parameters:
    jobNameSuffix: ''
    windowsImage: 'windows-2022-secure'
    macImage: 'macOS-11'
    linuxImage: 'ubuntu-22.04-secure'

jobs:
    - job: 'e2e_tests_windows${{ parameters.jobNameSuffix }}'
      templateContext:
        outputs:
        - output: pipelineArtifact
          targetPath: '$(System.DefaultWorkingDirectory)/test-results/e2e'
          artifactName: '$(Agent.JobName)-screenshots-and-extended-logs'
          condition: failed() # because the detailed chrome logs are ~150MB and uploading them takes ~30s
          continueOnError: true
          displayName: publish e2e screenshots and extended logs
          timeoutInMinutes: 5
      pool:
          name: a11y-insights-pool-dev
          vmImage: ${{ parameters.windowsImage }}
      steps:
          - template: ./install-node-prerequisites.yaml
          - template: ./e2e-test-from-agent.yaml
          - template: ./e2e-test-publish-results.yaml

    - job: 'e2e_tests_mac${{ parameters.jobNameSuffix }}'
      templateContext:
        outputs:
        - output: pipelineArtifact
          targetPath: '$(System.DefaultWorkingDirectory)/test-results/e2e'
          artifactName: '$(Agent.JobName)-screenshots-and-extended-logs'
          condition: failed() # because the detailed chrome logs are ~150MB and uploading them takes ~30s
          continueOnError: true
          displayName: publish e2e screenshots and extended logs
          timeoutInMinutes: 5
      pool:
          name: Azure Pipelines    
          vmImage: ${{ parameters.macImage }}
          os: macOS
      steps:
          - template: ./install-node-prerequisites.yaml
          - template: ./e2e-test-from-agent.yaml
          - template: ./e2e-test-publish-results.yaml

    - job: 'e2e_tests_linux${{ parameters.jobNameSuffix }}'
      templateContext:
        outputs:
        - output: pipelineArtifact
          targetPath: '$(System.DefaultWorkingDirectory)/test-results/e2e'
          artifactName: '$(Agent.JobName)-screenshots-and-extended-logs'
          condition: failed() # because the detailed chrome logs are ~150MB and uploading them takes ~30s
          continueOnError: true
          displayName: publish e2e screenshots and extended logs
          timeoutInMinutes: 5
      pool:
          name: Azure Pipelines
          vmImage: ${{ parameters.linuxImage }}
          os: linux
      steps:
          - template: ./run-tests-in-docker-linux.yaml
            parameters:
                target: web
          - template: ./e2e-test-publish-results.yaml
